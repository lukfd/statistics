---
title: "autoregression analysis"
author: "Luca Comba"
date: "3/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(forcats)
library(lubridate)
library(ggplot2)
library(vars)
library(mFilter)
```

# Read dataset

```{r, results = 'hide'}
fargo <- read.csv("C:/Users/Luca/Desktop/SPRING2021/Statistical Research/Correct Dataset/fargo.csv", encoding="UTF-8")
grand <- read.csv("C:/Users/Luca/Desktop/SPRING2021/Statistical Research/Correct Dataset/grand.csv", encoding="UTF-8")
```

# Creating time series

Now for each of the variable we are creating a time series.

For the discharge.

```{r, results = 'hide'}
# Discharge
grand_discharge_ts <- ts(grand$discharge,  
                         start = 2014, 
                         end = 2020,
                         frequency = 365)

fargo_discharge_ts <- ts(fargo$discharge,  
                         start = 2014, 
                         end = 2020,
                         frequency = 365)
```

For the average temperature.

```{r, results = 'hide'}
# Average Temperature
grand_temp_ts <- ts(grand$avg.temp,  
                         start = 2014, 
                         end = 2020,
                         frequency = 365)

fargo_temp_ts <- ts(fargo$avg.temp,  
                         start = 2014, 
                         end = 2020,
                         frequency = 365)
```

For the Evapotranspiration.

```{r, results = 'hide'}
# Evapotranspiration
grand_pen_ts <- ts(grand$penman.pet,  
                         start = 2014, 
                         end = 2020,
                         frequency = 365)

fargo_pen_ts <- ts(fargo$penman.pet,  
                         start = 2014, 
                         end = 2020,
                         frequency = 365)
```

For the rainfall.

```{r, results = 'hide'}
# Rainfall
grand_rainfall_ts <- ts(grand$rainfall,  
                         start = 2014, 
                         end = 2020,
                         frequency = 365)

fargo_rainfall_ts <- ts(fargo$rainfall,  
                         start = 2014, 
                         end = 2020,
                         frequency = 365)
```

For the snow depth

```{r, results = 'hide'}
# Snow Depth
grand_snow_ts <- ts(grand$snow.depth,  
                         start = 2014, 
                         end = 2020,
                         frequency = 365)

fargo_snow_ts <- ts(fargo$snow.depth,  
                         start = 2014, 
                         end = 2020,
                         frequency = 365)
```

For the top soil temperature.

```{r, results = 'hide'}
# Top Soil temperature
grand_top_soil_ts <- ts(grand$top.soil.temp,  
                         start = 2014, 
                         end = 2020,
                         frequency = 365)

fargo_top_soil_ts <- ts(fargo$top.soil.temp,  
                         start = 2014, 
                         end = 2020,
                         frequency = 365)
```

#### Plotting some time-series

This is for Grand Forks

```{r}
plot(cbind(grand_discharge_ts,grand_top_soil_ts,grand_rainfall_ts), main = "Grand - Discharge and Top Soil temperature")
```

This is for Fargo

```{r}
plot(cbind(fargo_discharge_ts,fargo_top_soil_ts,fargo_rainfall_ts), main = "Fargo - Discharge and Top Soil temperature")
```

# Seasonal Decomposition

Because our data shows that the time seires have a seasonal trend, then components of the time seires can be decomposed. In R we can do it with the `stl()` method.

Here is an exmple using Grand's discharge time-series.

```{r}
grand_discharge_fit <- stl(grand_discharge_ts, s.window="period")
plot(grand_discharge_fit, main = "Grand Discharge Decomposition")
```

Here is the decomposition for the rest of the data.
```{r, results = 'hide'}
# Grand
grand_pen_fit <- stl(grand_pen_ts, s.window="period")
grand_rainfall_fit <- stl(grand_rainfall_ts, s.window="period")
grand_snow_fit <- stl(grand_snow_ts, s.window="period")
grand_temp_fit <- stl(grand_temp_ts, s.window="period")
grand_top_soil_fit <- stl(grand_top_soil_ts, s.window="period")

# Fargo
fargo_discharge_fit <- stl(fargo_discharge_ts, s.window="period")
fargo_pen_fit <- stl(fargo_pen_ts, s.window="period")
fargo_rainfall_fit <- stl(fargo_rainfall_ts, s.window="period")
fargo_snow_fit <- stl(fargo_snow_ts, s.window="period")
fargo_temp_fit <- stl(fargo_temp_ts, s.window="period")
fargo_top_soil_fit <- stl(fargo_top_soil_ts, s.window="period")
```

Another way to decompose the Time-series is to use `decompose`

```
# Grand
grand_discharge_fit <- decompose(grand_discharge_ts)
grand_pen_fit <- decompose(grand_pen_ts)
grand_rainfall_fit <- decompose(grand_rainfall_ts)
grand_snow_fit <- decompose(grand_snow_ts)
grand_temp_fit <- decompose(grand_temp_ts)
grand_top_soil_fit <- decompose(grand_top_soil_ts)

# Fargo
fargo_discharge_fit <- decompose(fargo_discharge_ts)
fargo_pen_fit <- decompose(fargo_pen_ts)
fargo_rainfall_fit <- decompose(fargo_rainfall_ts)
fargo_snow_fit <- decompose(fargo_snow_ts)
fargo_temp_fit <- decompose(fargo_temp_ts)
fargo_top_soil_fit <- decompose(fargo_top_soil_ts)
```

# Vector Autoregression Analysis

After having uploaded the dataset and the correct libraries is time for creating time series objects.

We would need to check that has been completed correctly by plotting the data.

#### Autocorrelation

we would now need to check for autocorrelation.

```{r}
head(grand_discharge_fit$time.series)
```

**Trends** in the data for the Grand's discharge:

```{r}
plot(grand_discharge_fit$time.series[,"trend"])
acf(grand_discharge_fit$time.series[,"trend"])
```

For proceding to take out the seasonality, which means that after using decomposition into three components: trend, seasonal, and irregular, and then *apply VAR to the residuals (irregular components of the time series).*

The *Remainder* column in the Seasonal Decomposition of Time Series by Loess can be plotted and use it for the Vector Autoregression analysis.

```{r}
plot(grand_discharge_fit$time.series[,"remainder"])
acf(grand_discharge_fit$time.series[,"remainder"])
```

Then the residual, or called remainder, can be save into the fitted variables and used for the analysis.

```{r, results = 'hide'}
# Grand
grand_discharge_fit = grand_discharge_fit$time.series[,"remainder"]
grand_pen_fit = grand_pen_fit$time.series[,"remainder"]
grand_rainfall_fit = grand_rainfall_fit$time.series[,"remainder"]
grand_snow_fit = grand_snow_fit$time.series[,"remainder"]
grand_temp_fit = grand_temp_fit$time.series[,"remainder"]
grand_top_soil_fit = grand_top_soil_fit$time.series[,"remainder"]

# Fargo
fargo_discharge_fit = fargo_discharge_fit$time.series[,"remainder"]
fargo_pen_fit = fargo_pen_fit$time.series[,"remainder"]
fargo_rainfall_fit = fargo_rainfall_fit$time.series[,"remainder"]
fargo_snow_fit = fargo_snow_fit$time.series[,"remainder"]
fargo_temp_fit = fargo_temp_fit$time.series[,"remainder"]
fargo_top_soil_fit = fargo_top_soil_fit$time.series[,"remainder"]

```


#### Analysis

The analysis will start with the Grand Fork data. I have followed closely the tutorial on [kevinkotze.github.io](https://kevinkotze.github.io/ts-7-tut/)

###### Analysis for Grand Forks

First we can try the set of variables Discharge and Top Soil.

```{r}
# Selection of the variables
grand_bind_dis_top <- cbind(grand_discharge_fit, grand_top_soil_fit)
colnames(grand_bind_dis_top) <- c("discharge", "soil")
```

For the model selection and estimation we can use the VARselect method.

```{r}
# Set up the analysis
grand_model <- VARselect(grand_bind_dis_top, lag.max = 12, type = "const")
grand_model$selection
```

Because it seems that the best lag is 6 that would mean that the expected best p is 6.

```{r}
grand_est <- VAR(grand_bind_dis_top, p = 6, type = "const", season = NULL, 
    exog = NULL)
summary(grand_est)
```

We can test the model fit with many tests for example Portmanteau-test.

One question that we might have is what would would be the best value for the `lags.pt`?

```{r}
grand_serial <- serial.test(grand_est, lags.pt = 12, type = "PT.asymptotic")
grand_serial

plot(grand_serial, names = "discharge")
plot(grand_serial, names = "soil")
```

"To interpret these statistics note that if a p-value is greater than 5% would generally indicate that there is an absence of serial correlation. To test for heteroscedasticity in the residuals we can perform a multivariate ARCH Lagrange-Multiplier test."

```{r}
grand_arch <- arch.test(grand_est, lags.multi = 12, multivariate.only = TRUE)
grand_arch
```

Now we have the problem of heteroscedasticity.
This means that our data has heteroscedasticity since the p value is less than 0.05.

We would also need to check for normality

```{r}
grand_norm <- normality.test(grand_est, multivariate.only = TRUE)
grand_norm
```

In conclusion the data indicates that the residual are not normally distributed.

Then lastly to test for the structural break in the residuals we can apply a CUSUM test.
```{r}
grand_cusum <- stability(grand_est, type = "OLS-CUSUM")
plot(grand_cusum)
```


Other methods to use are: Granger causality, IRFs and variance decompositions.

```
grand_irf.int <- irf(grand_est, response = "discharge", n.ahead = 40, boot = TRUE)
plot(grand_irf.int)
```

# Resources used

Here is a list of some website used

- [Understanding Decomposition](https://anomaly.io/seasonal-trend-decomposition-in-r/index.html)
- [Documentation of stl()](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/stl)
- [Vector Autoregression Tutorial 1](https://kevinkotze.github.io/ts-7-tut/)
- [General R time series](https://www.statmethods.net/advstats/timeseries.html)

Also another question was asked on [StackOverflow](https://stackoverflow.com/questions/67066604/multiple-time-series-in-r-using-ts?noredirect=1#comment118547063_67066604)